<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="jquery.caret.js"></script>
<script src="jquery.tag-editor.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href="jquery.tag-editor.css" rel="stylesheet" type="text/css" media="all">
<link href='https://fonts.googleapis.com/css?family=Lobster' rel='stylesheet'>





<style>
.result
{
font-size: 22px;
text-align:left;
margin-bottom: 0px;
font-family: Lucida Grande;
font-weight: bold;
}
.horizontalScrollArea
{
overflow-x: scroll;
overflow-y: hidden;
white-space: nowrap;
border-style: solid;
}
.horizontalScrollItem
{
  display:inline-block;
  overflow:hidden;
border-style: solid;
}
.horizontalScrollItemSpacer
{
  width:10px;
  display:inline-block;
}



body
{
position:relative;
margin: 0;
z-index:-1;
  min-Width:800px;
}

#header
{
position:relative;
height:120px;
background-color:#f7ffe3;
}
#logo
{
position:absolute;
width:120px;
height:80px;
margin-left:10px;
margin-top:10px;
cursor:pointer;
}
#name
{
position:absolute;
font-size:25px;
font-family:'Lobster';
color:#336600;
margin-top:80px;
margin-left:10px;
cursor:pointer;
}
#input+.tag-editor
{
position:absolute;
width:550px;
z-index:0; 
border:2px solid black;
left:150px;
top:50;
}
#help
{
position:absolute;
color:black;
left:692px;
height:22px;
width:27px;
z-index:1;
font-size:25px;
cursor:pointer;
top:50px;
}
#submit
{
position:absolute;
left:710px;
height:30;
width:60;
z-index:1;
cursor:pointer;
top:50px;
}
#icon
{
float:right;
cursor:pointer;
width:80px;
height:50px;
margin-top: 40px;
margin-right: 20px;
}

#strainArea
{
margin-left:50px;
margin-top:50px;

}
#strainIcon
{
  width:300px;
  height:300px;
  float:left;
}
#ratingIcon
{
  width:50px;
  height:50px;
}
#cannabinoidArea
{
  height: 80px;
  width:400px;
}
#terpeneArea
{
  height:80px;
  width:400px;
}
#dispensaryArea
{
  margin-left:30;
}
#dispensaryScrollArea
{
margin-left:20px;
width:700px;
height:100px;
}
</style>
<body>

<div id="header">
  <img id="logo" src="logo.png" >
  <div id="name">
  Cannagenie
  </div>
  <input type="text" name="input" id="input"> 
  <div id="help">?</div>
  <img id="submit" src="images/logo/submit.png">
  <img id="icon" src="images/logo/user.png">
</div>

<div id="strainArea">
  <div id"strainInfoArea">
    <img id="strainIcon" src="logo.png">
    <span id="strainTitle" class="result">Super Lemon Haze</span>
    <span id="strainMatch" class="result"> - Match 80%</span>
    <div id="strainRatingArea">
      <span id="strainRatingIcons">
        <img id="ratingIcon" src="logo.png" >
      </span>
      <span id="strainNumberReviews">Reviews</span>
    </div>
    <div id="noidArea">
      <div id="cannabinoidArea" class="horizontalScrollArea">
        <div id="cannabinoids">
        </div>
      </div>

      <div id="terpeneArea" class="horizontalScrollArea">
        <div id="terpenes">
        </div>
      </div>
    </div>
    <div style="clear:both;"></div>
    <div id="strainDescription">Descript</div>
  </div>
</div>

    <div id="dispensaryArea">
      <div id="dispensaryHeader">
        Available At
      </div>
      <div id="dispensaryScrollArea"class="horizontalScrollArea">
        <div id="dispensaryResults">
          <div id="dispensaryResult" class="horizontalScrollItem link">
            <div id="dispensaryName"></div>
            <div id="dispensaryDistance"></div>
          </div>
      </div>
    </div>



<body>
<script>
$("#name").click(function() { window.location = "index.html"; });
$("#logo").click(function() { window.location = "index.html"; });

$("#help").click(function()
{
});

$("#submit").click(function()
{
var search = document.getElementById("input").value;

  if(search.length == 0)
  {
    //go to strain of the day
  }
  else
  {
    getValues();
  }
});
$("#icon").click(function()
{
});



  var socket = io();
  var socketId = null;

  const urlParams = new URLSearchParams(window.location.search);
  var searchValue = urlParams.get("search");
  var searchDispensary = urlParams.get("dispensary");
  if(searchValue == null)
    searchValue = "";
  

/*
--------------------------------------------
            Functions
--------------------------------------------
*/
  function SendSocket(id,data)
  {
    var obj = { ID:socketId, Data:data };
    socket.emit(id, obj)
  }

  function getValues(link)
  {
    var text = searchDispensary;
    if(link != null)
    {
      text = link.innerText;
    }

    Recommend(text);
  }

  function Recommend(dispensary)
  {
    var cSearchText = document.getElementById("input").value;
    document.getElementById("input").value = "";
    //get then reset .value incase user hit back button on result page

    if(cSearchText.length > 0)
    {
      socket.close();
      window.location = "results.html?" + "search=" + cSearchText +
      "&dispensary=" + dispensary;
    }
  }
/*
--------------------------------------------
            Socket functions
--------------------------------------------
*/
  socket.on("connect", function(data)
  {
    socketId = socket.id;

        console.log(searchValue);

   // SendSocket("recommend", searchValue);
  });
  //get unique ID when connected.

  socket.on("result", function(data)
  {
    if(data.ID == socketId)
    {
      data =  data.Data;


      var ul = document.getElementById("results");
  //    ul.innerHTML = "";
      //get unordered list and clear of list items.

      var result = document.getElementsByTagName("template")[0];     
      var noid = document.getElementsByTagName("template")[1];     

      console.log(data[5].details);

      
      for(var key in data)
      {

        var liClone = result.content.cloneNode(true);

        //image
        var imageName = data[key].details.image;
        if(imageName.length != 0)
        {
          liClone.querySelector("#strainPicture").src = 
            "bud_images/" + imageName;; 
        }

        //cheminoids
        var terpenes = data[key].details.terpenes;

        if(terpenes != "No Data")
        {
          terpeneArray = [
            ["delta-9 THC","THC"],
            ["CBD","CBD"],
            ["CBN","CBN"]
          ];
          terpeneArray.forEach(function(item) 
          {

          var noidClone = noid.content.cloneNode(true);
            noidClone.querySelector("#noid").innerText = 
              item[1] + "\n" + parseFloat(terpenes[item[0]]).toFixed(1) + "%";
            liClone.querySelector("#strainNoids").appendChild(noidClone);
          });
        }
        
        //Title
        liClone.querySelector("#strainTitle").textContent = data[key].name; 
        liClone.querySelector("#strainMatch").textContent = 
          " - Match: " + (100*data[key].similarity).toFixed(0) + "% - Rating: "; 
        
        //Description
        liClone.querySelector("#strainDescription").textContent =
        data[key].details.description;

        ul.append(liClone);
      }
      //for each item in the list. Should be 15 max. Pull the needed info and put
      //into a list item. append list item to unordered list.
    }
  });

/*
--------------------------------------------
            Tag search bar instance
--------------------------------------------
*/
 
    $('#input').tagEditor({
      initialTags: searchValue.split(","),
      delimiter: ',\t', 
      placeholder: 'Enter CannaGenie Tags...',
      forceLowercase: true,
      autocomplete: {
        delay:0 , 
        minLength: 1, 
        source: function(request, response) 
        {
          socket.emit("search",request.term, function (data)
          {
            response(data);
          });
        }
      }
  });
  
  $("#input").keyup(function(event)
  {
    console.log("down");
    if(event.keycode == 13)
    {
      Recommend();
    }
  });

  $(document).keydown(function(event)
  {
    if(event.which == 13)
    {
      Recommend();
    }
  });


</script>
