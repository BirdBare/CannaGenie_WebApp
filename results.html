<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="jquery.caret.js"></script>
<script src="jquery.tag-editor.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href="jquery.tag-editor.css" rel="stylesheet" type="text/css" media="all">
<link href='https://fonts.googleapis.com/css?family=Lobster' rel='stylesheet'>





<style>
.result
{
font-size: 18px; 
text-align:left;
margin-bottom: 0px;
font-family: Lucida Grande;
font-weight: bold;
}
.horizontalScrollArea
{
overflow-x: scroll;
overflow-y: hidden;
white-space: nowrap;
}
.horizontalScrollItem
{
  display:inline-block;
  overflow:hidden;
}
.horizontalScrollItemSpacer
{
  width:10px;
  display:inline-block;
}



body
{
position:relative;
margin: 0;
z-index:-1;
  min-Width:800px;
}

#header
{
position:relative;
height:120px;
background-color:#f7ffe3;
}
#logo
{
position:absolute;
width:120px;
height:80px;
margin-left:10px;
margin-top:10px;
cursor:pointer;
}
#name
{
position:absolute;
font-size:25px;
font-family:'Lobster';
color:#336600;
margin-top:80px;
margin-left:10px;
cursor:pointer;
}
#input+.tag-editor
{
position:absolute;
width:550px;
z-index:0; 
border:2px solid black;
left:150px;
top:50;
}
#help
{
position:absolute;
color:black;
left:692px;
height:22px;
width:27px;
z-index:1;
font-size:25px;
cursor:pointer;
top:50px;
}
#submit
{
position:absolute;
left:710px;
height:30;
width:60;
z-index:1;
cursor:pointer;
top:50px;
}
#icon
{
float:right;
cursor:pointer;
margin-top: 40px;
margin-right: 20px;
}

#searchArea
{
margin-left:125px;
height:95px;
width:600px;
}
#searchResult
{
  height:90px;
  width:115px;
}

#results
{
  list-style-type:none; 
  margin-left:20px;
  padding:0px;
}
#resultArea
{
  width:1000px;
}

#strainArea
{
  width:620px;
  height:100px;
  float:left;
}
#strainIcon
{
  width:80px;
  height:100px;
  margin-left:13px;
  margin-right:13px;
  position: relative;
  float:left;
}
#strainDescription
{
	position: relative;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  text-align:left;
  font-family: Lucida Grande;
  line-height: 1.5;
  word-spacing: 1.5;
 
}

#dispensaryArea
{
  margin-left:30px;;
  width:300px;
  height:100px;
  float:left;
}

#ratingIcon
{
  width:20px;
  height:20px;

}


</style>
<body>


<div id="header">
  <img id="logo" src="logo.png" >
  <div id="name">
  Cannagenie
  </div>
  <input type="text" name="input" id="input"> 
  <div id="help">?</div>
  <img id="submit" src="images/logo/submit.png">
  <img id="icon" src="images/logo/user.png">
</div>

<div id="searchArea" class="horizontalScrollArea">
  <div id="searchResults">
    <template>
      <div id="searchResult" class="horizontalScrollItem link"></div>
      <div class="horizontalScrollItemSpacer"></div>
    </template>
  </div>
</div>

<ul id="results">
  <template>
  <li id="resultArea">
  
  <div id="strainArea">
    <img id="strainIcon" src="logo.png" alt="picture of Bubble gum" >
    <span id="strainTitle" class="result">Super Lemon Haze - </span>
    <span id="strainMatch" class="result">Match 40% - </span>
    <span id="strainRating" class="result">Rating: </span>
    <span id="strainRatingIcons"> 
      <img id="ratingIcon" src="logo.png" >
    </span>
    <div id="resultTop3"> </div>
    <div id="strainDescription" class="">Description</div>
  </div>

  <div id="dispensaryArea">
    <div id="dispensaryHeader">
      Available At
    </div>
    <div class="horizontalScrollArea">
      <div id="dispensaryResults">
      <template>
        <div id="dispensaryResult" class="horizontalScrollItem link">
          <div id="dispensaryName"></div>
          <div id="dispensaryDistance"></div>
        </div>
      </template>
    </div>
  </div>

<div style="clear:both;"></div>

  </li>
  </template>
</ul>

<body>
<script>
$("#name").click(function() { window.location = "index.html"; });
$("#logo").click(function() { window.location = "index.html"; });

$("#help").click(function()
{
});

$("#submit").click(function()
{
var search = document.getElementById("input").value;

  if(search.length == 0)
  {
    //go to strain of the day
  }
  else
  {
    getValues();
  }
});
$("#icon").click(function()
{
});
</script>




<br>
<ul id="results" style="list-style-type:none; margin-left:0px;">
</ul>


<script>
  var lat;
  var lon;
  navigator.geolocation.getCurrentPosition(function (position)
  {
    lat = position.coords.latitude;
    lon = position.coords.longitude;
    console.log(lat + "      " + lon);
  });


  var socket = io();
  var socketId = null;

  const urlParams = new URLSearchParams(window.location.search);
  var searchValue = urlParams.get("search");
  var searchDispensary = urlParams.get("dispensary");
  
/*
--------------------------------------------
            Functions
--------------------------------------------
*/
  function SendSocket(id,data)
  {
    var obj = { ID:socketId, Data:data };
    socket.emit(id, obj)
  }

  function getValues(link)
  {
    var text = searchDispensary;
    if(link != null)
    {
      text = link.innerText;
    }

    Recommend(text);
  }

  function GenerateSearch()
  { 
    SendSocket("GenerateSearch",searchValue);
  }

  function GenerateRecommendation()
  {
    SendSocket("GenerateRecommendation",searchValue);
  }

  function Recommend()
  {
    var cSearchText = document.getElementById("input").value;
    document.getElementById("input").value = "";
    //get then reset .value incase user hit back button on result page

    if(cSearchText.length > 0)
    {
      socket.close();
      window.location = "results.html?" + "search=" + cSearchText;
    }
  }
/*
--------------------------------------------
            Socket functions
--------------------------------------------
*/
  socket.on("connect", function(data)
  {
    socketId = socket.id;

        console.log(searchValue);

    GenerateSearch();
    GenerateRecommendation();
  });
  //get unique ID when connected.

  socket.on("RecommendationResult", function(data)
  {
    if(data.ID == socketId)
    {
      data =  data.Data;


      var ul = document.getElementById("results");
  //    ul.innerHTML = "";
      //get unordered list and clear of list items.

      var result = document.getElementsByTagName("template")[1];     
      var noid = document.getElementsByTagName("template")[2];     

      console.log(data[4].details);

      
      for(var key in data)
      {

        var liClone = result.content.cloneNode(true);

        //image
        var imageName = data[key].details.image;
        if(imageName.length != 0)
        {
          liClone.querySelector("#strainIcon").src = 
            "bud_images/" + imageName; 
        }

        //cheminoids
        var terpenes = data[key].details.terpenes;

        if(terpenes != "No Data")
        {
          terpeneArray = [
            ["delta-9 THC","THC"],
            ["CBD","CBD"],
            ["CBN","CBN"]
          ];
          terpeneArray.forEach(function(item) 
          {

          //var noidClone = noid.content.cloneNode(true);
            //noidClone.querySelector("#noid").innerText = 
              //item[1] + "\n" + parseFloat(terpenes[item[0]]).toFixed(1) + "%";
            //liClone.querySelector("#strainNoids").appendChild(noidClone);
          });
        }
        
        //Title
        liClone.querySelector("#strainTitle").textContent = data[key].name; 
        liClone.querySelector("#strainMatch").textContent = 
          " - Match: " + (100*data[key].similarity).toFixed(0) + "% - Rating: "; 
        
        //Description
        liClone.querySelector("#strainDescription").textContent =
        data[key].details.description;

        ul.append(liClone);
      }
      //for each item in the list. Should be 15 max. Pull the needed info and put
      //into a list item. append list item to unordered list.
    }
  });

/*
--------------------------------------------
            Tag search bar instance
--------------------------------------------
*/
 
    $('#input').tagEditor({
      initialTags: searchValue.split(","),
      delimiter: ',\t', 
      placeholder: 'Enter CannaGenie Tags...',
      forceLowercase: true,
      autocomplete: {
        delay:0 , 
        minLength: 1, 
        source: function(request, response) 
        {
          socket.emit("search",request.term, function (data)
          {
            response(data);
          });
        }
      }
  });
  
  $("#input").keyup(function(event)
  {
    console.log("down");
    if(event.keycode == 13)
    {
      Recommend();
    }
  });

  $(document).keydown(function(event)
  {
    if(event.which == 13)
    {
      Recommend();
    }
  });


</script>
