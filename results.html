<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="jquery.caret.js"></script>
<script src="jquery.tag-editor.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href="jquery.tag-editor.css" rel="stylesheet" type="text/css" media="all">

       	<style>
       		.float-img{
              position: relative;
       			  float:left;
       			  margin-right: 10px;
       		}
       		
       		.container1{
       			position: relative;
       			overflow: hidden;
            margin-top:40px;
            width:750px;
            height:135px;
            font-family: Lucida Grande;
            background-color: blue;
       		}

       		.box1{
       			position: relative;
       			overflow: hidden;
            background-color: orange;
       		}


       		.box1_1{  
       			position: relative;
       			float: left;
            font-size:15px;
       			width: 40px;
       			height: 30px;
       			margin:1px 0px 5px 0px ;
            text-align:left;
            font-family: Lucida Grande;
           background-color: yellow;
       		}

       		.box2{  
				position: relative;
       			overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            text-align:left;
            font-family: Lucida Grande;
            background-color: green;
       		}
       	</style>


<template>
  <div style="margin-left: 125px;">
		<div class="container1"> 
			<a style="text-decoration:none" href="strain.html"> 
      <img id="strainPicture" src="logo.png" width="130" height="130" alt="picture of Bubble gum" class="float-img">
      
      </a>
      
      <a style="text-decoration:none" href="strain.html"> </a>
      <div id="strainTitle" style="font-size: 18px; 
                                   text-align:left;
                                   margin-bottom: 0px;
                                   font-family: Lucida Grande;
                                   font-weight: bold;">

     
      </div>
      
      <div class="box1" id="strainNoids">
        
      </div>

			<div id="strainDescription" class="box2">
      </div>
      
      <div style="clear:both">
      </div>
    </div>
  </div>
</template>
<template>
  <div class="box1_1" id="noid"> 
	</div>
</template>



<div id="container" style="position:relative;">
    <!img src="logo.png" alt="CannaGenie Logo"><br>
    <div id="cSearchBar" style="max-width:500px;">
      <input type="text" name="cSearch" id="cSearch"> 
    </div>
    <div id="cSubmit" style="position:relative; top:5px;" >
      <button id="cSubmitButton" type="button" class="button" onclick="Recommend()"> I'm
      feeling lucky </button>
    </div>
</div>

<ul id="results" style="list-style-type:none;">
</ul>




<script>
  var socket = io();
  var socketId = null;

  url = window.location.href;
  var searchStart = url.indexOf("search=",0);
  var searchEnd = url.indexOf("&",searchStart);
  var searchString = url.substring(searchStart,searchEnd).replace("search=","");
  searchString = searchString.replace(/%20/g," ").replace(/%27/g,"'");
  //parse website parameters

/*
--------------------------------------------
            Functions
--------------------------------------------
*/
  function SendSocket(id,data)
  {
    var obj = { ID:socketId, Data:data };
    socket.emit(id, obj)
  }

  function Recommend()
  {
    var cSearchText = document.getElementById("cSearch").value;
    document.getElementById("cSearch").value = "";
    //get then reset .value incase user hit back button on result page

    if(cSearchText.length > 0)
    {
      socket.close();
      window.location = "results.html?" + "search=" + cSearchText + "&";
    }
  }
/*
--------------------------------------------
            Socket functions
--------------------------------------------
*/
  socket.on("connect", function(data)
  {
    socketId = socket.id;

        console.log(searchString);

    SendSocket("recommend", searchString);
  });
  //get unique ID when connected.

  socket.on("result", function(data)
  {
    if(data.ID == socketId)
    {
      data =  data.Data;


      var ul =document.getElementById("results");
      ul.innerHTML = "";
      //get unordered list and clear of list items.

      var result = document.getElementsByTagName("template")[0];     
      var noid = document.getElementsByTagName("template")[1];     

      console.log(data[5].details);

      
      for(var key in data)
      {

        var liClone = result.content.cloneNode(true);

        //image
        var imageName = data[key].details.image;
        if(imageName.length != 0)
        {
          liClone.querySelector("#strainPicture").src = 
            "bud_images/" + imageName;; 
        }

        //cheminoids
        var terpenes = data[key].details.terpenes;

        if(terpenes != "No Data")
        {
          terpeneArray = [
            ["delta-9 THC","THC"],
            ["CBD","CBD"]
          ];
          terpeneArray.forEach(function(item) 
          {

          var noidClone = noid.content.cloneNode(true);
            noidClone.querySelector("#noid").innerText = 
              item[1] + "\n" + parseFloat(terpenes[item[0]]).toFixed(1) + "%";
            liClone.querySelector("#strainNoids").appendChild(noidClone);
          });
        }
        else
        {
          var noidClone = noid.content.cloneNode(true);
          liClone.querySelector("#strainNoids").appendChild(noidClone);
        }
        //Title
        liClone.querySelector("#strainTitle").textContent = 
          data[key].name + " - Match: " + (100*data[key].similarity).toFixed(0)
          + "% - Rating: "; 
        
        //Description
        liClone.querySelector("#strainDescription").textContent =
        data[key].details.description;

        ul.append(liClone);
      }
      //for each item in the list. Should be 15 max. Pull the needed info and put
      //into a list item. append list item to unordered list.
    }
  });

/*
--------------------------------------------
            Tag search bar instance
--------------------------------------------
*/
 
    $('#cSearch').tagEditor({
      initialTags: searchString.split(","),
      delimiter: ',\t', 
      placeholder: 'Enter CannaGenie Tags...',
      forceLowercase: true,
      autocomplete: {
        delay:0 , 
        minLength: 1, 
        source: function(request, response) 
        {
          socket.emit("search",request.term, function (data)
          {
            response(data);
          });
        }
      }
  });
  
  $("#cSearch").keyup(function(event)
  {
    console.log("down");
    if(event.keycode == 13)
    {
      Recommend();
    }
  });

  $(document).keydown(function(event)
  {
    if(event.which == 13)
    {
      Recommend();
    }
  });


</script>
